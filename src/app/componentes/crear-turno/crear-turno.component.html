<div class="crear-turno-container">
  <div class="crear-turno-content">
    
    <!-- Header -->
    <div class="turno-header" *ngIf="etapa != 'confirmar' && etapa != 'fin'">
      <h1 class="turno-title">
        <i class="fa fa-calendar-plus-o"></i> {{usuario?.tipo === 'admin' ? 'Crear Turno' : 'Solicitar Turno'}}
      </h1>
      <p class="turno-subtitle">Complete los pasos para reservar su turno</p>
    </div>

    <!-- PASO 0: Selección de Paciente (Solo Admin) -->
    <div class="seccion-pacientes" *ngIf="etapa == 'paciente'">
      <h3 class="paso-titulo">
        <span class="paso-numero">1</span> Seleccione el Paciente
      </h3>
      <div class="pacientes-grid">
        <div *ngFor="let paciente of pacientes" class="paciente-item" (click)="elegirPaciente(paciente)">
          <div class="paciente-card-modern">
            <div class="paciente-foto-container">
              <img [src]="paciente.foto1 || 'assets/imagenes/paciente.png'" 
                   class="paciente-foto" 
                   [alt]="paciente.apellido"
                   (error)="onImageError($event)">
            </div>
            <div class="paciente-info">
              <h4 class="paciente-nombre">{{paciente.nombre}} {{paciente.apellido}}</h4>
              <p class="paciente-email">
                <i class="fa fa-envelope"></i> {{paciente.email}}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PASO 1/2: Selección de Especialista -->
    <div class="seccion-especialistas" *ngIf="etapa == 'especialista'">
      <h3 class="paso-titulo">
        <span class="paso-numero">{{usuario?.tipo === 'admin' ? '2' : '1'}}</span> Seleccione un Especialista
      </h3>
      
      <!-- Mostrar paciente seleccionado si es admin -->
      <p class="paciente-seleccionado" *ngIf="usuario?.tipo === 'admin' && pacienteElegidoStr">
        <i class="fa fa-user"></i> Paciente: <strong>{{pacienteElegidoStr}}</strong>
      </p>
      
      <div *ngIf="especialistas.length == 0" class="sin-resultados">
        <i class="fa fa-info-circle"></i>
        <p>No se encuentran especialistas disponibles.</p>
      </div>

      <div class="especialistas-grid" *ngIf="especialistas.length > 0">
        <div *ngFor="let esp of especialistas" class="especialista-item" (click)="elegirEspecialista(esp)">
          <div class="especialista-card-modern">
            <div class="especialista-foto-container">
              <img [src]="esp.foto1 || 'assets/imagenes/especialista.png'" 
                   class="especialista-foto" 
                   [alt]="esp.apellido"
                   (error)="onImageError($event)">
            </div>
            <div class="especialista-info">
              <h4 class="especialista-nombre">{{esp.nombre}} {{esp.apellido}}</h4>
              <p class="especialista-especialidades">
                <i class="fa fa-user-md"></i> 
                <span *ngFor="let especialidad of esp.especialidad; let last = last">
                  {{especialidad.especialidad}}<span *ngIf="!last">, </span>
                </span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="acciones-footer" *ngIf="especialistas.length > 0">
        <button class="btn-volver" (click)="volver(usuario?.tipo === 'admin' ? 'paciente' : 'home')">
          <i class="fa fa-arrow-left"></i> Volver
        </button>
      </div>
    </div>

    <!-- PASO 2/3: Selección de Especialidad -->
    <div class="seccion-especialidades" *ngIf="etapa == 'especialidad'">
      <h3 class="paso-titulo">
        <span class="paso-numero">{{usuario?.tipo === 'admin' ? '3' : '2'}}</span> Seleccione una Especialidad
      </h3>
      
      <!-- Mostrar paciente seleccionado si es admin -->
      <p class="paciente-seleccionado" *ngIf="usuario?.tipo === 'admin' && pacienteElegidoStr">
        <i class="fa fa-user"></i> Paciente: <strong>{{pacienteElegidoStr}}</strong>
      </p>
      
      <p class="especialidad-seleccionada">
        <i class="fa fa-user-md"></i> Especialista: <strong>{{especialistaElegidoStr}}</strong>
      </p>
      
      <div *ngIf="especialistaElegido?.especialidad?.length == 0" class="sin-resultados">
        <i class="fa fa-info-circle"></i>
        <p>Este especialista no tiene especialidades registradas.</p>
        <button class="btn-volver" (click)="volver('especialista')">
          <i class="fa fa-arrow-left"></i> Elegir otro especialista
        </button>
      </div>

      <div class="especialidades-grid" *ngIf="especialistaElegido?.especialidad?.length > 0">
        <div *ngFor="let especialidad of especialistaElegido.especialidad" class="especialidad-item" (click)="elegirEspecialidad(especialidad.especialidad)">
          <div class="especialidad-card-modern">
            <div class="especialidad-icon">
              <i class="fa fa-stethoscope"></i>
            </div>
            <h4 class="especialidad-nombre">{{especialidad.especialidad}}</h4>
            <div class="especialidad-hover-effect"></div>
          </div>
        </div>
      </div>
      
      <div class="acciones-footer" *ngIf="especialistaElegido?.especialidad?.length > 0">
        <button class="btn-volver" (click)="volver('especialista')">
          <i class="fa fa-arrow-left"></i> Volver
        </button>
      </div>
    </div>

    <!-- PASO 3/4: Selección de Día y Horario -->
    <div class="seccion-horarios" *ngIf="etapa == 'horario'">
      <h3 class="paso-titulo">
        <span class="paso-numero">3</span> Seleccione Día y Horario
      </h3>
      
      <div class="seleccion-resumen">
        <div class="resumen-item" *ngIf="usuario?.tipo === 'admin'">
          <i class="fa fa-user"></i> <strong>Paciente:</strong> {{pacienteElegidoStr}}
        </div>
        <div class="resumen-item">
          <i class="fa fa-check-circle"></i> <strong>Especialidad:</strong> {{especialidadElegida}}
        </div>
        <div class="resumen-item">
          <i class="fa fa-user-md"></i> <strong>Especialista:</strong> {{especialistaElegidoStr}}
        </div>
      </div>

      <!-- Grid de días (15 días) -->
      <div class="dias-section">
        <h4 class="seccion-subtitulo">
          <i class="fa fa-calendar"></i> Seleccione un día
        </h4>
        <div class="dias-grid">
          <div *ngFor="let diaDisponible of diasDisponibles; let i = index" 
               class="dia-card" 
               [class.dia-selected]="diaSeleccionadoIndex === i"
               [class.dia-inhabilitado]="!diaDisponible.disponible"
               (click)="seleccionarDia(i)">
            <div class="dia-fecha">{{formatearFechaBoton(diaDisponible.fecha)}}</div>
          </div>
        </div>
      </div>

      <!-- Horarios disponibles para el día seleccionado -->
      <div class="horarios-section" *ngIf="diaSeleccionadoIndex !== -1">
        <h4 class="seccion-subtitulo">
          <i class="fa fa-clock-o"></i> Horarios disponibles para {{diasDisponibles[diaSeleccionadoIndex]?.diaNombre}} {{diasDisponibles[diaSeleccionadoIndex]?.diaNumero}} de {{diasDisponibles[diaSeleccionadoIndex]?.mesNombre}}
        </h4>
        
        <div *ngIf="noHayDatos" class="sin-horarios">
          <i class="fa fa-calendar-times-o"></i>
          <p>{{noHayDatos}}</p>
        </div>

        <div class="horarios-grid" *ngIf="!noHayDatos && horariosDisponiblesDelDia.length > 0">
          <button *ngFor="let horario of horariosDisponiblesDelDia" 
                  class="horario-btn" 
                  (click)="elegirHorario(horario)">
            <i class="fa fa-clock-o"></i>
            {{formatearHora(horario)}}
          </button>
        </div>
      </div>

      <div class="acciones-footer">
        <button class="btn-volver" (click)="volver('especialidad')">
          <i class="fa fa-arrow-left"></i> Volver
        </button>
      </div>
    </div>

    <!-- Turno Solicitado -->
    <div *ngIf="etapa == 'fin'" class="seccion-exito">
      <div class="exito-icon">
        <i class="fa fa-check-circle"></i>
      </div>
      <h2 class="exito-titulo">¡Turno Solicitado Exitosamente!</h2>
      <p class="exito-mensaje">Su turno ha sido registrado correctamente.</p>
      <button class="btn-mis-turnos" (click)="volver('irMisTurno')">
        <i class="fa fa-list-alt"></i> Ver Mis Turnos
      </button>
    </div>

  </div>
</div>

<!-- MODAL DE CONFIRMACIÓN -->
<div class="modal-overlay-turno" *ngIf="etapa == 'confirmar'" (click)="cerrarModalConfirmacion()">
  <div class="modal-confirmacion" (click)="$event.stopPropagation()">
    
    <!-- Header del Modal -->
    <div class="modal-header-turno">
      <h3 class="modal-titulo-turno">
        <i class="fa fa-check-circle"></i> Confirmar Turno
      </h3>
      <button class="modal-close-btn-turno" (click)="cerrarModalConfirmacion()">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <!-- Contenido del Modal -->
    <div class="modal-body-turno">
      <p class="modal-descripcion-turno">
        Por favor, revise los datos de su turno antes de confirmar:
      </p>

      <!-- Información del Turno -->
      <div class="turno-info-card">
        <div class="info-row" *ngIf="usuario?.tipo === 'admin'">
          <div class="info-icon">
            <i class="fa fa-user"></i>
          </div>
          <div class="info-content">
            <span class="info-label">Paciente</span>
            <span class="info-value">{{pacienteElegidoStr}}</span>
          </div>
        </div>
        
        <div class="info-row">
          <div class="info-icon">
            <i class="fa fa-stethoscope"></i>
          </div>
          <div class="info-content">
            <span class="info-label">Especialidad</span>
            <span class="info-value">{{especialidadElegida}}</span>
          </div>
        </div>

        <div class="info-row">
          <div class="info-icon">
            <i class="fa fa-user-md"></i>
          </div>
          <div class="info-content">
            <span class="info-label">Especialista</span>
            <span class="info-value">{{especialistaElegidoStr}}</span>
          </div>
        </div>

        <div class="info-row">
          <div class="info-icon">
            <i class="fa fa-calendar"></i>
          </div>
          <div class="info-content">
            <span class="info-label">Fecha y Hora</span>
            <span class="info-value">{{diaElegido}}</span>
          </div>
        </div>

        <div class="info-row" *ngIf="duracionTurno">
          <div class="info-icon">
            <i class="fa fa-hourglass-half"></i>
          </div>
          <div class="info-content">
            <span class="info-label">Duración</span>
            <span class="info-value">{{duracionTurno}} minutos</span>
          </div>
        </div>
      </div>

      <div class="modal-advertencia">
        <i class="fa fa-info-circle"></i>
        <p>Una vez confirmado, el turno quedará registrado en el sistema.</p>
      </div>
    </div>

    <!-- Footer del Modal -->
    <div class="modal-footer-turno">
      <button class="btn-modal-cancelar-turno" (click)="cerrarModalConfirmacion()">
        <i class="fa fa-times"></i> Cancelar
      </button>
      <button class="btn-modal-confirmar-turno" (click)="confirmar()">
        <i class="fa fa-check"></i> Confirmar Turno
      </button>
    </div>

  </div>
</div>
