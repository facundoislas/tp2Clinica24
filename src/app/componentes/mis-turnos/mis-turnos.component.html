<!-- Spinner de Carga -->
<div class="loading-overlay" *ngIf="loading">
  <div class="spinner-container">
    <img src="assets/imagenes/logo2.png" alt="Cargando..." class="spinner-logo">
    <p class="loading-text">Cargando datos...</p>
  </div>
</div>

<div class="fondo-principal" *ngIf="!loading">
    <div class="content-overlay">
        <div class="container card mt-5">
            <!-- Filtro -->
            <div style="text-align: center;" class="mb-4">
                <h4>Filtrar Turnos</h4>
                <input name="filtro" [(ngModel)]="filtro" class="form-control" placeholder="Ingrese el nombre de la especialidad o nombre del especialista o paciente..."/>
            </div>
            <!-- Filtro -->
    
            <div class="row">
                <!-- Lista  -->
                <div class="col-md-4 order-md-1 mb-4">
                    <h4 class="text-center mb-4">Turnos</h4>
                    <div class="list-group">
                        <button
                            type="button"
                            class="list-group-item list-group-item-action"
                            *ngFor="let turno of turnos | filtros:filtro:especialistas:pacientes:historiaPrevia"
                            [appEstadoColor]="turno.estado"
                            appResaltar
                            [colorResaltar]="'rgba(32, 201, 151, 0.2)'"
                            (click)="verTurno(turno)">
                            <i>{{turno.especialidad}} - {{turno.dia}} de {{turno.mes}}</i>
                        </button>
                        <div style="text-align: center;" *ngIf="(turnos | filtros:filtro:especialistas:pacientes:historiaPrevia).length == 0" class="mt-3">
                            <p style="color: #e5e7eb;">No se encontró ningún turno</p>
                        </div> 
                    </div>
                </div>
                <!-- Lista  -->
    
                <!-- Detalles -->
                <div class="col-md-8 order-md-2">
                    <h4 style="text-align: center;" class="mb-4">Información</h4>
                    <div class="mb-3">
                    <label for="fecha">Fecha</label>
                    <input name="mail" [(ngModel)]="fechaAux" [readonly]="true" class="form-control"/>
                </div>
                <div class="row">
                    <!-- Para Paciente: solo muestra Especialista -->
                    <div class="col-md-6 mb-3" *ngIf="usuario && usuario.tipo == 'paciente'">
                        <label for="especialista">Especialista</label>
                        <input name="especialista" [(ngModel)]="especialistaNombreCompleto" [readonly]="true" class="form-control"/>
                    </div>
                    
                    <!-- Para Especialista: solo muestra Paciente -->
                    <div class="col-md-6 mb-3" *ngIf="usuario && usuario.tipo == 'especialista'">
                        <label for="paciente">Paciente</label>
                        <input name="paciente" [(ngModel)]="pacienteNombreCompleto" [readonly]="true" class="form-control"/>
                    </div>
                    
                    <!-- Para Admin: muestra ambos -->
                    <div class="col-md-6 mb-3" *ngIf="usuario && usuario.tipo == 'admin'">
                        <label for="especialista-admin">Especialista</label>
                        <input name="especialista-admin" [(ngModel)]="especialistaNombreCompleto" [readonly]="true" class="form-control"/>
                    </div>
                    <div class="col-md-6 mb-3" *ngIf="usuario && usuario.tipo == 'admin'">
                        <label for="paciente-admin">Paciente</label>
                        <input name="paciente-admin" [(ngModel)]="pacienteNombreCompleto" [readonly]="true" class="form-control"/>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="apellido">Especialidad</label>
                        <input name="apellido" [(ngModel)]="especialidad" [readonly]="true" class="form-control"/>
                    </div>
                </div>
                
                <!-- Estado del turno -->
                <div class="mb-3">
                    <label for="estado">Estado</label>
                    <button class="w-100 btn notButton" [ngClass]="{'btn-secondary': estado == 'pendiente','btn-danger': estado == 'cancelado' || estado == 'rechazado', 'btn-primary': estado == 'aceptado', 'btn-success': estado == 'finalizado'}">{{estado}}</button> 
                </div>
                <!-- Estado del turno -->
                
                <div class="mb-3" *ngIf="estado == 'finalizado'">
                    <label for="apellido">Turno</label>
                        <div class="info-card turno-card">
                            <div class="info-item">
                                <span class="info-label">Diagnóstico:</span>
                                <span class="info-value">{{turnoElegido.comentario}}</span>
                            </div>
                            <div class="info-item" *ngIf="usuario && usuario.tipo == 'especialista' && turnoElegido.calificacion !==''">
                                <span class="info-label">Calificación:</span>
                                <span class="info-value">{{turnoElegido.calificacion}}</span>
                            </div>
                        </div>
                        <div class="mb-3" *ngIf="obtenerHistoriaDelTurno(turnoElegido.id) as historia">
                            <label for="apellido">Historia Clínica</label>
                            <div class="info-card historia-card">
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Altura:</span>
                                        <span class="info-value">{{historia.altura}} cm</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Peso:</span>
                                        <span class="info-value">{{historia.peso}} kg</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Presión:</span>
                                        <span class="info-value">{{historia.presion}}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Temperatura:</span>
                                        <span class="info-value">{{historia.temperatura}}°C</span>
                                    </div>
                                </div>
                                <hr class="info-divider">
                                <h5 class="dinamicos-title">Mas Datos</h5>
                                <div class="dinamicos-list">
                                    <div class="info-item" *ngFor="let dinamico of historia.dinamicos">
                                        <span class="info-label">{{dinamico.clave}}:</span>
                                        <span class="info-value">{{dinamico.valor}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                    <!-- Botones Paciente -->
                    <div style="text-align: center;" class="mt-4" *ngIf="usuario && usuario.tipo == 'paciente'">
                        <button *ngIf="estado != 'finalizado' && estado != 'cancelado' && estado != 'rechazado' && estado != ''" class="w-50 btn btn-danger" (click)="abrirPopUp('cancelar')">Cancelar turno</button> 
                        <button *ngIf="comentario != '' || resenia != ''" (click)="abrirPopUp('reseña')" class="w-30 btn btn-primary calificadores">Ver reseña</button> 
                        <button *ngIf="estado == 'finalizado'" (click)="abrirPopUp('calificar')" class="w-30 btn btn-primary calificadores">{{calificacion == '' ? 'Calificar atención' : 'Ver calificación'}}</button> 
                        <button *ngIf="comentario != '' && estado == 'finalizado'" (click)="abrirPopUp('encuesta')" class="w-30 btn btn-primary calificadores">{{turnoElegido.encuesta && turnoElegido.encuesta !== '' ? 'Ver encuesta' : 'Completar encuesta'}}</button> 
                    </div>
                    <!-- Botones Paciente -->
        
                    <!-- Botones Especialista -->
                    <div style="text-align: center;" class="mt-4" *ngIf="usuario && usuario.tipo == 'especialista'">
                        <button *ngIf="estado != 'aceptado' && estado != 'rechazado' && estado != 'finalizado' && estado != 'cancelado' && estado != ''" class="w-30 btn btn-primary calificadores" (click)="modificarTurnoSinComentario('aceptado')">Aceptar turno</button> 
                        <button *ngIf="estado == 'aceptado'" class="w-50 btn btn-success" (click)="abrirPopUp('finalizado')">Finalizar turno</button> 
                        <button *ngIf="estado != 'aceptado' && estado != 'rechazado' && estado != 'finalizado' && estado != 'cancelado' && estado != ''" class="w-30 btn btn-warning calificadores" (click)="abrirPopUp('rechazar')">Rechazar turno</button> 
                        <button *ngIf="estado != 'aceptado' && estado != 'rechazado' && estado != 'finalizado' && estado != 'cancelado' && estado != ''" class="w-30 btn btn-danger calificadores" (click)="abrirPopUp('cancelar')">Cancelar turno</button> 
                        <button *ngIf="comentario != ''" (click)="abrirPopUp('reseña')" class="w-50 btn btn-primary">Ver reseña</button> 
                    </div>
                    <!-- Botones Especialista -->
        
                    <!-- Botones Admin -->
                    <div style="text-align: center;" class="mt-4" *ngIf="usuario && usuario.tipo == 'admin'">
                        <button *ngIf="estado != 'aceptado' && estado != 'finalizado' && estado != 'rechazado' && estado != 'cancelado' && estado != ''" class="w-50 btn btn-warning" (click)="abrirPopUp('cancelar')">Cancelar turno</button> 
                    </div>
                    <!-- Botones Admin -->
                </div>
                <!-- Detalles -->
    
            </div>
        </div>
    
        <!-- PopUp -->
    <div class="modal fade" id="cancelarTurno" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content text-bg-dark" style="text-align: center;">
                <!-- cancelar -->
                <div class="card-color" *ngIf="popUpRazon == 'cancelar'">
                    <br>
                    <h1>Cancelar turno</h1>
                    <br>
                    <label class="form-label" for="textAreaExample">Comentario</label>
                    <textarea [(ngModel)]="comentarioAux" (ngModelChange)="resetearMensajeError()" style="margin: 0 auto; float: none;" class="form-control w-50" id="textAreaExample1" rows="4"></textarea>
                    <br>
                    <p style="color: red;">{{mensajeError}}</p>
                    <button class="btn btn-secondary" style="margin: 0 auto; float: none;" (click)="modificarTurno('cancelado')">Cancelar turno</button> 
                    <br>
                    <br>
                </div>
                <!-- cancelar -->
    
                <!-- rechazar -->
                <div class="card-color" *ngIf="popUpRazon == 'rechazar'">
                    <br>
                    <h1>Rechazar turno</h1>
                    <br>
                    <label class="form-label" for="textAreaExample">Comentario</label>
                    <textarea [(ngModel)]="comentarioAux" (ngModelChange)="resetearMensajeError()" style="margin: 0 auto; float: none;" class="form-control w-50" id="textAreaExample1" rows="4"></textarea>
                    <br>
                    <p style="color: red;">{{mensajeError}}</p>
                    <button class="btn btn-secondary" style="margin: 0 auto; float: none;" (click)="modificarTurno('rechazado')">Rechazar turno</button> 
                    <br>
                    <br>
                </div>
                <!-- rechazar -->
    
                <!-- reseña -->
                <div class="card-color" *ngIf="popUpRazon == 'reseña'">
                    <br>
                    <h1>Reseña</h1>
                    {{comentario}}
                    {{resenia}}
                    <br>
                    <br>
                    <button class="btn btn-secondary" style="margin: 0 auto; float: none;" (click)="cerrarPopUp()">Cerrar</button> 
                    <br>
                    <br>
                </div>
                <!-- reseña -->
    
                <!-- finalizado -->
                <div class="card-color" *ngIf="popUpRazon == 'finalizado'">
                    <br>
                    <h1>Finalizado</h1>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="altura">Altura</label>
                            <input name="altura" [(ngModel)]="altura" class="form-control"/>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="peso">Peso</label>
                            <input name="peso" [(ngModel)]="peso" class="form-control"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="temperatura">Temperatura</label>
                            <input name="temperatura" [(ngModel)]="temperatura" class="form-control"/>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="presion">Presion</label>
                            <input name="presion" [(ngModel)]="presion" class="form-control"/>
                        </div>
                    </div>
                    <h4>Más Datos</h4>
                    <div class="row" *ngFor="let item of [].constructor(cantidadDatos); let i=index">
                        <div class="col-md-6 mb-3">
                            <label for="temperatura">Clave</label>
                            <input name="temperatura" placeholder="Ej: caries" [(ngModel)]="dinamicos[i].clave" class="form-control"/>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="presion">Valor</label>
                            <input name="presion" placeholder="Ej: 4" [(ngModel)]="dinamicos[i].valor" class="form-control"/>
                        </div>
                        <!--div class="col-md-6 mb-3">
                            <label for="customRange1" class="form-label">Rango de 0 a 100</label>
                            <input name="temperatura" type="range"  min="0" max="100" placeholder="Ej: caries" [(ngModel)]="dinamicos[i].rango" class="form-range" id="customRange1"/>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="presion">Numero</label>
                            <input name="presion" type="number" placeholder="Ej: 4" [(ngModel)]="dinamicos[i].numero" class="form-control"/>
                        </div>
                        <div class="col-md-6 mb-3 form-check form-switch d-flex align-items-center justify-content-center">
                            <input class="form-check-input me-2" type="checkbox" role="switch" id="flexSwitchCheckDefault" [(ngModel)]="dinamicos[i].eleccion"/>
                            <label for="flexSwitchCheckDefault" class="form-check-label">Elección</label>
                        </div-->
                    </div>
                    <div>
                        <button *ngIf="cantidadDatos > 0" class="btn btn-secondary" style="margin: 0 auto; float: none;" (click)="agregarValorDinamico('restar')">Restar dato</button>
                        <button *ngIf="cantidadDatos < 3" class="btn btn-secondary" style="margin: 0 auto; float: none;" (click)="agregarValorDinamico('sumar')">Agregar dato</button>
                    </div>
                    <br>
                    <label class="form-label" for="textAreaExample">Comentario</label>
                    <textarea [(ngModel)]="comentarioAux" (ngModelChange)="resetearMensajeError()" style="margin: 0 auto; float: none;" class="form-control w-50" id="textAreaExample1" rows="4"></textarea>
                    <br>
                    <p style="color: red;">{{mensajeError}}</p>
                    <button class="btn btn-secondary" style="margin: 0 auto; float: none;" (click)="finalizarTurno()">Finalizar turno</button>
                    <br>
                    <br>
                    <button class="btn btn-secondary" style="margin: 0 auto; float: none;" (click)="cerrarPopUp()">Cerrar</button> 
                    <br>
                    <br>
                </div>
                <!-- finalizado -->
    
                <!-- Calificar -->
                <div class="card-color" *ngIf="popUpRazon == 'calificar'">
                    <br>
                    <h1>{{turnoElegido.calificacion == '' ? '¿Cómo calificarias la atencion de nuestro profesional?' : 'Calificación de la atención'}}</h1>
                    <div style="font-size: 40px" class="star-wrapper">
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
                        <span class="fa fa-star s1" [class.readonly-star]="turnoElegido.calificacion != ''" [class.checked]="estrellas >= 5" (click)="turnoElegido.calificacion == '' ? calificar(5) : null"></span> 
                        <span class="fa fa-star s2" [class.readonly-star]="turnoElegido.calificacion != ''" [class.checked]="estrellas >= 4" (click)="turnoElegido.calificacion == '' ? calificar(4) : null"></span> 
                        <span class="fa fa-star s3" [class.readonly-star]="turnoElegido.calificacion != ''" [class.checked]="estrellas >= 3" (click)="turnoElegido.calificacion == '' ? calificar(3) : null"></span> 
                        <span class="fa fa-star s4" [class.readonly-star]="turnoElegido.calificacion != ''" [class.checked]="estrellas >= 2" (click)="turnoElegido.calificacion == '' ? calificar(2) : null"></span> 
                        <span class="fa fa-star s5" [class.readonly-star]="turnoElegido.calificacion != ''" [class.checked]="estrellas >= 1" (click)="turnoElegido.calificacion == '' ? calificar(1) : null"></span>
                    </div>
                    <div>
                        <label class="form-label" for="textAreaExample">Comentario</label>
                        <textarea [(ngModel)]="calificacion" [readonly]="turnoElegido.calificacion != ''" (ngModelChange)="resetearMensajeError()" style="margin: 0 auto; float: none;" class="form-control w-50" id="textAreaExample1" rows="4"></textarea>
                        <br>
                        <p style="color: red;">{{mensajeError}}</p>
                        <button *ngIf="turnoElegido.calificacion == ''" class="btn btn-secondary" style="margin: 0 auto; float: none;" (click)="calificarTurno()">Calificar</button>
                        <button *ngIf="turnoElegido.calificacion != ''" class="btn btn-secondary" style="margin: 0 auto; float: none;" (click)="cerrarPopUp()">Cerrar</button> 
                        <br>
                        <br>
                    </div>
                </div>
                <!-- Calificar -->
    
                <!-- encuesta -->
                <div class="card-color" *ngIf="popUpRazon == 'encuesta'">
                <br>
                <h1>{{turnoElegido.encuesta && turnoElegido.encuesta !== '' ? 'Encuesta Completada' : 'Encuesta'}}</h1>
                <label for="pregunta1">¿Cómo calificarias las instalaciones de nuestro establecimiento?</label>
                <input name="pregunta1" [(ngModel)]="preguntas[0]" [readonly]="turnoElegido.encuesta && turnoElegido.encuesta !== ''" (ngModelChange)="resetearMensajeError()" class="w-75 form-control" style="margin: 0 auto; float: none;"/>
                <br>
                <label for="pregunta2">¿Deberiamos mejorar aspectos de nuestra clinica?</label>
                <input name="pregunta2" [(ngModel)]="preguntas[1]" [readonly]="turnoElegido.encuesta && turnoElegido.encuesta !== ''" (ngModelChange)="resetearMensajeError()" class="w-75 form-control" style="margin: 0 auto; float: none;"/>
                <br>
                <label for="pregunta3">¿Recomendaría nuestra clínica a familiares y amigos?</label>
                <input name="pregunta3" [(ngModel)]="preguntas[2]" [readonly]="turnoElegido.encuesta && turnoElegido.encuesta !== ''" (ngModelChange)="resetearMensajeError()" class="w-75 form-control" style="margin: 0 auto; float: none;"/>
                <br>
                <p style="color: red;">{{mensajeError}}</p>
                <button *ngIf="!turnoElegido.encuesta || turnoElegido.encuesta === ''" class="btn btn-secondary" style="margin: 0 auto; float: none;" (click)="llenarEncuesta()">Completar encuesta</button>
                <button *ngIf="turnoElegido.encuesta && turnoElegido.encuesta !== ''" class="btn btn-secondary" style="margin: 0 auto; float: none;" (click)="cerrarPopUp()">Cerrar</button> 
                <br>
                <br>
            </div>
            <!-- encuesta -->
                
            </div>
        </div>
    </div>

