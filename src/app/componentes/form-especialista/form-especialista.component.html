<div class="especialista-container">
    <div class="especialista-content">
        <div class="especialista-card">
            <div class="card-header">
                <h3>Registro de Especialista</h3>
                <p class="subtitle">Complete sus datos para registrarse</p>
            </div>
            
            <div class="card-body">
                <div class="form-layout" *ngIf="logeando">
                    <!-- Columna izquierda: Formulario -->
                    <div class="form-column">
                        <form [formGroup]="formRegistro" class="especialista-form">
                    <!-- Primera fila: 3 campos -->
                    <div class="form-row">
                        <!-- Campo Nombre -->
                        <div class="form-group col-4">
                            <label for="nombre" class="form-label">Nombre</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa fa-user"></i></span>
                                </div>
                                <input 
                                    type="text" 
                                    id="nombre"
                                    placeholder="Nombre" 
                                    class="form-control"
                                    [class.is-invalid]="formRegistro.get('nombre')?.invalid && formRegistro.get('nombre')?.touched"
                                    [class.is-valid]="formRegistro.get('nombre')?.valid && formRegistro.get('nombre')?.touched"
                                    formControlName="nombre" 
                                    [(ngModel)]="this.especialista.nombre">
                            </div>
                            <div class="validation-messages" *ngIf="formRegistro.get('nombre')?.invalid && formRegistro.get('nombre')?.touched">
                                <small class="text-danger" *ngIf="formRegistro.get('nombre')?.errors?.['required']">
                                    <i class="fa fa-exclamation-circle"></i> Requerido
                                </small>
                            </div>
                        </div>

                        <!-- Campo Apellido -->
                        <div class="form-group col-4">
                            <label for="apellido" class="form-label">Apellido</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa fa-user"></i></span>
                                </div>
                                <input 
                                    type="text" 
                                    id="apellido"
                                    placeholder="Apellido" 
                                    class="form-control"
                                    [class.is-invalid]="formRegistro.get('apellido')?.invalid && formRegistro.get('apellido')?.touched"
                                    [class.is-valid]="formRegistro.get('apellido')?.valid && formRegistro.get('apellido')?.touched"
                                    formControlName="apellido" 
                                    [(ngModel)]="this.especialista.apellido">
                            </div>
                            <div class="validation-messages" *ngIf="formRegistro.get('apellido')?.invalid && formRegistro.get('apellido')?.touched">
                                <small class="text-danger" *ngIf="formRegistro.get('apellido')?.errors?.['required']">
                                    <i class="fa fa-exclamation-circle"></i> Requerido
                                </small>
                            </div>
                        </div>

                        <!-- Campo Edad -->
                        <div class="form-group col-4">
                            <label for="edad" class="form-label">Edad</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                                </div>
                                <input 
                                    type="number" 
                                    id="edad"
                                    placeholder="Edad" 
                                    class="form-control"
                                    [class.is-invalid]="formRegistro.get('edad')?.invalid && formRegistro.get('edad')?.touched"
                                    [class.is-valid]="formRegistro.get('edad')?.valid && formRegistro.get('edad')?.touched"
                                    formControlName="edad" 
                                    [(ngModel)]="this.especialista.edad">
                            </div>
                            <div class="validation-messages" *ngIf="formRegistro.get('edad')?.invalid && formRegistro.get('edad')?.touched">
                                <small class="text-danger" *ngIf="formRegistro.get('edad')?.errors?.['required']">
                                    <i class="fa fa-exclamation-circle"></i> Requerido
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Segunda fila: DNI, Especialidad y Email -->
                    <div class="form-row">
                        <!-- Campo DNI -->
                        <div class="form-group col-4">
                            <label for="dni" class="form-label">DNI</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa fa-id-card"></i></span>
                                </div>
                                <input 
                                    type="number" 
                                    id="dni"
                                    placeholder="DNI" 
                                    class="form-control"
                                    [class.is-invalid]="formRegistro.get('dni')?.invalid && formRegistro.get('dni')?.touched"
                                    [class.is-valid]="formRegistro.get('dni')?.valid && formRegistro.get('dni')?.touched"
                                    formControlName="dni" 
                                    [(ngModel)]="this.especialista.dni">
                            </div>
                            <div class="validation-messages" *ngIf="formRegistro.get('dni')?.invalid && formRegistro.get('dni')?.touched">
                                <small class="text-danger" *ngIf="formRegistro.get('dni')?.errors?.['required']">
                                    <i class="fa fa-exclamation-circle"></i> Requerido
                                </small>
                            </div>
                        </div>

                        <!-- Campo Especialidades (Selección Múltiple) -->
                        <div class="form-group col-8">
                            <label class="form-label">
                                <i class="fa fa-stethoscope"></i> Especialidades 
                                <span class="badge badge-info ml-2">{{especialidadesSeleccionadas.length}} seleccionadas</span>
                            </label>
                            
                            <!-- Grid de especialidades con checkboxes -->
                            <div class="especialidades-grid">
                                <div class="especialidad-checkbox" *ngFor="let esp of especialidades">
                                    <label class="checkbox-label">
                                        <input 
                                            type="checkbox" 
                                            [checked]="isEspecialidadSeleccionada(esp.especialidad)"
                                            (change)="toggleEspecialidad(esp.especialidad, $event)">
                                        <span class="checkbox-custom"></span>
                                        <span class="checkbox-text">{{esp.especialidad}}</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Botón para agregar nueva especialidad -->
                            <div class="mt-2">
                                <button 
                                    type="button" 
                                    class="btn btn-sm btn-outline-primary" 
                                    (click)="mostrarFormularioNuevaEspecialidad()"
                                    *ngIf="!mostrarNuevaEspecialidad">
                                    <i class="fa fa-plus"></i> Agregar nueva especialidad
                                </button>
                            </div>
                            
                            <!-- Campo para nueva especialidad -->
                            <div class="nueva-especialidad mt-2" *ngIf="mostrarNuevaEspecialidad">
                                <div class="input-group">
                                    <input 
                                        type="text" 
                                        placeholder="Nueva especialidad"
                                        class="form-control form-control-sm"
                                        [class.input-duplicado]="especialidadYaExiste()"
                                        [(ngModel)]="nuevaEspecialidad"
                                        [ngModelOptions]="{standalone: true}">
                                    <div class="input-group-append">
                                        <button 
                                            type="button" 
                                            class="btn btn-success btn-sm" 
                                            [disabled]="especialidadYaExiste() || !nuevaEspecialidad.trim()"
                                            (click)="agregarNuevaEspecialidad()">
                                            <i class="fa fa-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm" (click)="cancelarNuevaEspecialidad()">
                                            <i class="fa fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <!-- Mensaje de advertencia si ya existe -->
                                <div class="alerta-duplicado" *ngIf="especialidadYaExiste()">
                                    <small class="text-danger">
                                        <i class="fa fa-exclamation-triangle"></i> Esta especialidad ya existe
                                    </small>
                                </div>
                                <!-- Mensaje de ayuda -->
                                <div class="ayuda-texto" *ngIf="nuevaEspecialidad.trim() && !especialidadYaExiste()">
                                    <small class="text-success">
                                        <i class="fa fa-check-circle"></i> Especialidad disponible
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Mensaje de validación -->
                            <div class="validation-messages" *ngIf="!tieneEspecialidadSeleccionada">
                                <small class="text-warning">
                                    <i class="fa fa-exclamation-triangle"></i> Debe seleccionar al menos una especialidad
                                </small>
                            </div>
                        </div>

                    </div>

                    <!-- Tercera fila: Email -->
                    <div class="form-row">
                        <!-- Campo Email -->
                        <div class="form-group col-12">
                            <label for="email" class="form-label">Email</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa fa-envelope"></i></span>
                                </div>
                                <input 
                                    type="email" 
                                    id="email"
                                    placeholder="correo@ejemplo.com" 
                                    class="form-control"
                                    [class.is-invalid]="formRegistro.get('email')?.invalid && formRegistro.get('email')?.touched"
                                    [class.is-valid]="formRegistro.get('email')?.valid && formRegistro.get('email')?.touched"
                                    formControlName="email" 
                                    [(ngModel)]="this.especialista.email">
                            </div>
                            <div class="validation-messages" *ngIf="formRegistro.get('email')?.invalid && formRegistro.get('email')?.touched">
                                <small class="text-danger" *ngIf="formRegistro.get('email')?.errors?.['required']">
                                    <i class="fa fa-exclamation-circle"></i> Requerido
                                </small>
                                <small class="text-danger" *ngIf="formRegistro.get('email')?.errors?.['email']">
                                    <i class="fa fa-exclamation-circle"></i> Formato inválido
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Cuarta fila: Contraseñas y Foto -->
                    <div class="form-row">
                        <!-- Campo Contraseña -->
                        <div class="form-group col-4">
                            <label for="contrasena" class="form-label">Contraseña</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa fa-lock"></i></span>
                                </div>
                                <input 
                                    type="password" 
                                    id="contrasena"
                                    placeholder="Contraseña" 
                                    class="form-control"
                                    [class.is-invalid]="formRegistro.get('contrasena')?.invalid && formRegistro.get('contrasena')?.touched"
                                    [class.is-valid]="formRegistro.get('contrasena')?.valid && formRegistro.get('contrasena')?.touched"
                                    formControlName="contrasena" 
                                    [(ngModel)]="this.especialista.pass">
                            </div>
                            <div class="validation-messages" *ngIf="formRegistro.get('contrasena')?.invalid && formRegistro.get('contrasena')?.touched">
                                <small class="text-danger" *ngIf="formRegistro.get('contrasena')?.errors?.['required']">
                                    <i class="fa fa-exclamation-circle"></i> Requerido
                                </small>
                            </div>
                        </div>

                        <!-- Campo Confirmar Contraseña -->
                        <div class="form-group col-4">
                            <label for="contrasena2" class="form-label">Confirmar</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa fa-lock"></i></span>
                                </div>
                                <input 
                                    type="password" 
                                    id="contrasena2"
                                    placeholder="Confirmar" 
                                    class="form-control"
                                    [class.is-invalid]="formRegistro.get('contrasena2')?.invalid && formRegistro.get('contrasena2')?.touched"
                                    [class.is-valid]="formRegistro.get('contrasena2')?.valid && formRegistro.get('contrasena2')?.touched"
                                    formControlName="contrasena2" 
                                    [(ngModel)]="this.contrasena2">
                            </div>
                            <div class="validation-messages" *ngIf="formRegistro.get('contrasena2')?.invalid && formRegistro.get('contrasena2')?.touched">
                                <small class="text-danger" *ngIf="formRegistro.get('contrasena2')?.errors?.['required']">
                                    <i class="fa fa-exclamation-circle"></i> Requerido
                                </small>
                            </div>
                        </div>

                        <!-- Campo Foto -->
                        <div class="form-group col-4">
                            <label for="foto1" class="form-label">Foto Perfil</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa fa-camera"></i></span>
                                </div>
                                <input 
                                    type="file" 
                                    id="foto1"
                                    accept="image/*"
                                    class="form-control file-input"
                                    [class.is-invalid]="formRegistro.get('foto1')?.invalid && formRegistro.get('foto1')?.touched"
                                    [class.is-valid]="formRegistro.get('foto1')?.valid && formRegistro.get('foto1')?.touched"
                                    formControlName="foto1" 
                                    (change)="onFileSelected($event)">
                            </div>
                            <div class="validation-messages" *ngIf="formRegistro.get('foto1')?.invalid && formRegistro.get('foto1')?.touched">
                                <small class="text-danger" *ngIf="formRegistro.get('foto1')?.errors?.['required']">
                                    <i class="fa fa-exclamation-circle"></i> Requerido
                                </small>
                            </div>
                        </div>
                    </div>
                        </form>
                    </div>
                    
                    <!-- Columna derecha: Captcha y Botones -->
                    <div class="actions-column">
                        <!-- Captcha -->
                        <div class="captcha-section">
                            <app-captcha2 (resultadoFinal)="tomarResultado($event)"></app-captcha2>
                        </div>

                        <!-- Botones -->
                        <div class="button-group">
                        <button 
                            type="button" 
                            class="btn btn-primary registro-btn" 
                            [disabled]="!formRegistro.valid || !captchaValidado || !tieneEspecialidadSeleccionada"
                            (click)="enviar()">
                            <i class="fa fa-user-plus"></i> Registrarse
                        </button>
                        
                        <div class="secondary-buttons">
                            <button type="button" class="btn btn-outline-secondary" (click)="limpiarFormulario()">
                                <i class="fa fa-eraser"></i> Limpiar
                            </button>
                            <button type="button" class="btn btn-outline-primary" routerLink="/login">
                                <i class="fa fa-sign-in"></i> Ya tengo cuenta
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Barra de Progreso -->
                <div class="progress-container" *ngIf="!logeando">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             [class]="clase" 
                             role="progressbar" 
                             [style.width]="ProgresoDeAncho"
                             [attr.aria-valuenow]="progreso" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{progresoMensaje}} - {{progreso}}%
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mensaje de notificación -->
        <div id="snackbar">{{Mensaje}}</div>
    </div>
</div>